<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ã‚³ã‚­ã‚¿æ•™è‚²å§”å“¡ä¼šï¼šå•é¡Œç·¨é›†</title>
    <link rel="stylesheet" href="/stylesheets/question_edit.css">
</head>
<body>
    <header class="header">
        <div class="menu-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div>ãƒ‹ã‚³ã‚­ã‚¿æ•™è‚²å§”å“¡ä¼šï¼šå•é¡Œç·¨é›†</div>
        <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š<%= name %></div>
    </header>

    <nav class="sidebar" id="sidebar">
        <a href="/main">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</a>
        <a href="/mondai">å•é¡Œå‡ºé¡Œ</a>
        <a href="/Question_manage">å•é¡Œç®¡ç†</a>
        <a href="javascript:void(0);" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </nav>

    <!-- å³å´ã‹ã‚‰å‡ºã¦ãã‚‹å†™çœŸãƒ‘ãƒãƒ«ãƒœã‚¿ãƒ³ -->
    <div class="image-panel-button" id="imagePanelButton">å†™çœŸ</div>

    <!-- å³å´ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ãƒ‘ãƒãƒ« -->
    <div class="image-panel" id="imagePanel">
        <h2>ç”»åƒä¸€è¦§</h2>
        <div class="search-container">
            <input type="search" id="search-box" placeholder="å†™çœŸã‚’æ¤œç´¢">
            <span class="search-icon">ğŸ”</span>
            <button id="search-button">æ¤œç´¢</button>
        </div><br>
        <div class="image-list" id="imageListContainer"></div>
    </div>

    <div id = "zoomback">
        <img id = "zoomimg" src = "">
    </div>


    <main class="main-content">
        <h1 class="title">å•é¡Œã®ç·¨é›†</h1>
        <p class="subtitle">å„é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

        <form id="questionForm">

            <div class="form-group">
                <label class="form-label">è©¦é¨“åï¼š</label>
                <input type="text" class="form-input" name="quealification_name" value="<%= question.qualification_name %>" required>
            </div>

            <div class="form-group">
                <label class="form-label">å¹´åº¦ï¼š</label>
                <input type="text" class="form-input" name="question_years" value="<%= question.question_years %>" required>
            </div>

            <div class="form-group">
                <label class="form-label">ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</label>
                <input type="text" class="form-input" name="question_genre" value="<%= question.question_genre %>" required>
            </div>

            <div class="form-group">
                <label class="form-label">å•é¡Œåï¼š</label>
                <input type="text" class="form-input" name="question_name" value="<%= question.question_name %>" required>
            </div>

            <div class="form-group">
                <label class="form-label">å•é¡Œæ–‡ï¼š</label>
                <textarea class="form-input question-text" name="question_text" required><%= question.question_text %></textarea>
            </div>

            <!-- é¸æŠè‚¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="options-container">
                <% if (question.options) { %>
                    <% const options = question.options.split(', '); %>
                    <% options.forEach((option, index) => { %>
                        <div class="form-group option-group">
                            <label class="form-label">é¸æŠè‚¢<%= index + 1 %>ï¼š</label>
                            <input type="text" class="form-input" name="options[]" value="<%= option %>" required>
                        </div>
                    <% }); %>
                <% } %>
            </div>

            <button type="button" id="add-option-btn" class="add-option-btn">é¸æŠè‚¢ã‚’è¿½åŠ </button>
            <button type="button" class="add-option-btn" id="deleteChoiceBtn">é¸æŠè‚¢å‰Šé™¤</button>
            <p id="error-message" class="error-message"></p>

            <div class="form-group">
                <label class="form-label">å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«åï¼š</label>
                <input type="text" class="form-input" name="pics_name" value="<%= question.pics_name %>">
            </div>

            <div class="form-group">
                <label class="form-label">æ­£è§£ï¼š</label>
                <input type="text" class="form-input" name="correct" value="<%= question.correct %>" required>
            </div>

            <div class="form-group">
                <button type="submit" class="submit-btn">ç·¨é›†å®Œäº†</button>
                <button class="submit-btn" onclick="window.history.back();">æˆ»ã‚‹</button>
            </div>
        </form>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({transports: ['websocket'], upgrade: false});
        // é¸æŠè‚¢è¿½åŠ æ©Ÿèƒ½
        const optionsContainer = document.getElementById('options-container');
        const addOptionBtn = document.getElementById('add-option-btn');
        const errorMessage = document.getElementById('error-message');
        const zoom = document.querySelectorAll(".zoom");
        const zoomback = document.getElementById("zoomback");
        const zoomimg = document.getElementById("zoomimg");


        window.addEventListener('load', function(){			
           socket.emit('image_List');		
        });

       // ç”»åƒãƒªã‚¹ãƒˆå–å¾—å¾Œã€ãƒ‘ãƒãƒ«å†…ã«è¡¨ç¤º
       socket.on('imageList', function(files) {
            console.log('Received image list:', files);
            const imageListContainer = document.getElementById('imageListContainer');
            imageListContainer.innerHTML = ''; // åˆæœŸåŒ–

            files.forEach(file => {
                const imageItem = document.createElement('div');
                imageItem.classList.add('image-item');

                const img = document.createElement('img');
                img.src = '/images/' + file;
                img.classList.add('zoom')

                const fileName = document.createElement('p');
                fileName.textContent = file; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º

                imageItem.appendChild(img);
                imageItem.appendChild(fileName);
                imageListContainer.appendChild(imageItem);
            });

            const zoomElements = document.querySelectorAll('.zoom');
            zoomElements.forEach(function(value) {
                value.addEventListener("click", kakudai);
            });
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
        document.getElementById('questionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            // FormDataã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
            formData.forEach((value, key) => {
                // é¸æŠè‚¢ï¼ˆoptions[]ï¼‰ã‚’é…åˆ—ã«ã¾ã¨ã‚ã‚‹
                if (key === 'options[]') {
                    if (!data.options) data.options = [];
                    data.options.push(value);
                } else {
                    data[key] = value;
                }
            });
            data.id = "<%= question_ID %>"; // ç·¨é›†å¯¾è±¡ã®IDã‚’è¿½åŠ 
            console.log("å‡¦ç†ã‚’é–‹å§‹");
            socket.emit('question_update', data);
        });

        socket.on('update_result',function(){
            window.location.href="/Question_manage";
        })

        socket.on('update_error',function(){
            alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        })

         // å†™çœŸãƒªã‚¹ãƒˆæ¤œç´¢ãƒœã‚¿ãƒ³
         document.getElementById('search-button').addEventListener('click', function() {
            var searchTerm = document.getElementById('search-box').value;
            if(searchTerm == ''){
                socket.emit('image_List')
            }else{
                socket.emit('search_img', searchTerm);
            }
        });

        //æ¤œç´¢çµæœè¡¨ç¤º
        socket.on('image_result', function(file) {
            console.log('Received image list:', file);
            const imageListContainer = document.getElementById('imageListContainer');
            imageListContainer.innerHTML = ''; // åˆæœŸåŒ–
            const imageItem = document.createElement('div');
            imageItem.classList.add('image-item');

            const img = document.createElement('img');
            img.src = '/images/' + file;
            img.classList.add('zoom')

            const fileName = document.createElement('p');
            fileName.textContent = file; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º

            imageItem.appendChild(img);
            imageItem.appendChild(fileName);
            imageListContainer.appendChild(imageItem);

            const zoomElements = document.querySelectorAll('.zoom');
            zoomElements.forEach(function(value) {
                value.addEventListener("click", kakudai);
            });
        });

        socket.on('image_error', function(error) {
            console.log(error);
        });


        //é¸æŠè‚¢å‰Šé™¤ãƒœã‚¿ãƒ³
        document.getElementById('deleteChoiceBtn').addEventListener('click', function() {
            const container = document.getElementById('options-container');
            const errorMessage = document.getElementById('error-message');
            if (container.children.length < 1) {
                errorMessage.textContent = 'é¸æŠè‚¢ã¯ãã‚Œä»¥ä¸Šæ¶ˆã›ã¾ã›ã‚“ã€‚';
                return;
            }
            container.removeChild(container.lastElementChild);
        });

        // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºéè¡¨ç¤º
        const imagePanelButton = document.getElementById('imagePanelButton');
        const imagePanel = document.getElementById('imagePanel');
        let panelOpen = false;

        imagePanelButton.addEventListener('click', function() {
            panelOpen = !panelOpen;
            if(panelOpen) {
                imagePanel.classList.add('open');
            } else {
                imagePanel.classList.remove('open');
            }
        });

        zoom.forEach(function(value) {
            value.addEventListener("click",kakudai);
        });

        function kakudai(e) {
            zoomback.style.display = "flex";
            zoomimg.setAttribute("src",e.target.getAttribute("src"));
        }

        zoomback.addEventListener("click",modosu);

        function modosu() {
            zoomback.style.display = "none";
        }

        //é¸æŠè‚¢è¿½åŠ å‡¦ç†
        addOptionBtn.addEventListener('click', () => {
            const currentOptions = optionsContainer.querySelectorAll('.option-group');
            if (currentOptions.length >= 10) {
                errorMessage.textContent = 'é¸æŠè‚¢ã¯æœ€å¤§10å€‹ã¾ã§è¿½åŠ ã§ãã¾ã™ã€‚';
                return;
            }
            errorMessage.textContent = ''; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            const newOptionIndex = currentOptions.length + 1;
            const newOption = document.createElement('div');
            newOption.className = 'form-group option-group';
            newOption.innerHTML = `
                <label class="form-label">é¸æŠè‚¢${newOptionIndex}ï¼š</label>
                <input type="text" class="form-input" name="options[]" required>
            `;
            optionsContainer.appendChild(newOption);
        });



        const menuButton = document.querySelector('.menu-icon'); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å–å¾—
        const sidebar = document.getElementById('sidebar'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å–å¾—
        const mainContent = document.querySelector('.main-content'); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('active'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            mainContent.classList.toggle('sidebar-active'); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½™ç™½èª¿æ•´
        });

            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
            document.addEventListener('click', (event) => {
                if (!menuButton.contains(event.target) && !sidebar.contains(event.target)) {
                    sidebar.classList.remove('active'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    mainContent.classList.remove('sidebar-active'); // ä½™ç™½èª¿æ•´ã‚’è§£é™¤
                }
            });

            //ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            async function logout() {
                try {
                    await new Promise((resolve, reject) => {
                        socket.emit('session_destroy', (response) => {
                            if (response.success) resolve();
                            else reject(response.error);
                        });
                    });
                    // æˆåŠŸæ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = '/login';
                } catch (error) {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
            
            socket.on('session_destroy_success', () => {
                window.location.href = '/login';
            });
    </script>
</body>
</html>
