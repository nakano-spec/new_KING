<!DOCTYPE html>
<html lang ="ja">
    <head>
        <meta charset="utf-8">
        <title>回答</title>
        <link type="text/css" rel="stylesheet" href="/stylesheets/kaitou2.css">
    </head>
    <body>
        <header class="header">
            <button class="menu-button" aria-label="メニュー">
                <div class="menu-line"></div>
                <div class="menu-line"></div>
                <div class="menu-line"></div>
            </button>
            <div class="header-title">ニコキタ教育委員会：解答</div>
            <div>ユーザー：<%= name %></div>
        </header>
        <nav class="sidebar" id="sidebar">
            <a href="javascript:void(0);" onclick="logout()">ログアウト</a>
        </nav>
        <script src ="/socket.io/socket.io.js"></script>
        <br>
        <br>
        <h1><%= question_text %></h1>
        <br>
        <br>
        <div class="buttons">
            <!-- 動的にボタンを生成 -->
        </div>
        <div class="textarea-container" style="display: none;">
            <textarea id="freeTextAnswer" rows="6" cols="50" placeholder="あなたの回答を入力してください"></textarea><br>
            <button id="submitTextAnswer">送信</button>
        </div>
        <!-- 確認モーダル-->
        <div class="modal" id="confirmationModal">
            <div class="modal-content">
                回答はこれでよろしいでしょうか？
                <div class="highlight" id="selectedAnswer"></div>
            </div>
            <div class="modal-buttons">
                <button id="confirmYes">はい</button>
                <button id="confirmNo">いいえ</button>
            </div>
        </div>
        <div class="overlay" id="overlay"></div>
        <!-- <script src="/javascripts/kaitou2.js"></script> -->
        <script>
            // サーバーに解答を送信
const socket = io({ transports: ['websocket'], upgrade: false });
const roomID = 'teacher';
const role = 2
if (roomID) {
        socket.emit('join_room', { roomID, role });
        console.log(`ルーム ${roomID} に参加しました (役割: ${role})`);
} else {
    console.error('ルームIDが指定されていません。');
}
const urlParams = new URLSearchParams(window.location.search);
const room_ID = urlParams.get('name');
const question_text = urlParams.get('question_text');
const options = JSON.parse(urlParams.get('options'));
console.log(options)
// HTML要素を取得
const buttonContainer = document.querySelector(".buttons");

const menuButton = document.querySelector('.menu-button'); // メニューボタンを取得
const sidebar = document.getElementById('sidebar'); // サイドバーを取得
const mainContent = document.querySelector('.main-content'); // メインコンテンツを取得

// メニューボタンのクリックイベント
menuButton.addEventListener('click', () => {
    sidebar.classList.toggle('active'); // サイドバーの表示切り替え
    mainContent.classList.toggle('sidebar-active'); // メインコンテンツの余白調整
});

// ドキュメント全体でクリックされたときの処理
document.addEventListener('click', (event) => {
    if (!menuButton.contains(event.target) && !sidebar.contains(event.target)) {
        sidebar.classList.remove('active'); // サイドバーを非表示にする
        mainContent.classList.remove('sidebar-active'); // 余白調整を解除
    }
});

//モーダル関連要素取得
const modal = document.getElementById('confirmationModal');
const overlay = document.getElementById('overlay');
const selectedAnswer = document.getElementById('selectedAnswer');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
const textareaContainer = document.querySelector(".textarea-container");
if(options[0] != null){
 // 解答部分のみを抽出しシャッフル
 const answers = options.map(option => {
        const strItem = String(option).replace(/[：；]/g, ":");
        const [, right] = strItem.split(":");
        return right.trim(); // 解答部分（右側）
    }).sort(() => Math.random() - 0.5); // シャッフル

    // 選択肢とシャッフルされた解答を対応付け
    options.forEach((item, index) => {
        const strItem = String(item).replace(/[：；]/g, ":");
        const [left] = strItem.split(":"); // 選択肢部分（左側）

        // ボタンを追加
        const button = document.createElement("button");
        button.textContent = `${left}: ${answers[index]}`; // シャッフルされた解答を表示
        button.value = answers[index]; // ボタンの値を解答として設定
        buttonContainer.appendChild(button);

        // ボタンクリック時の処理
        button.addEventListener("click", () => {
            currentAnswer = answers[index];
            selectedAnswer.textContent = button.textContent; // モーダルに表示する選択肢
            modal.style.display = 'block';
            overlay.style.display = 'block';
        });
    });
}else{
    const button = document.createElement("button");
    textareaContainer.style.display = 'block';

    // テキストエリアの送信ボタンのクリックイベントを設定
    document.getElementById('submitTextAnswer').addEventListener('click', () => {
        const freeText = document.getElementById('freeTextAnswer').value.trim();
        if (freeText === '') {
            alert('回答を入力してください');
            return;
        }

        currentAnswer = freeText;
        selectedAnswer.textContent = freeText;
        modal.style.display = 'block';
        overlay.style.display = 'block';
    });
}

 // モーダルの「はい」ボタン処理
 confirmYes.addEventListener('click', () => {
        alert(`回答を送信しました！`);
        console.log(currentAnswer);
        modal.style.display = 'none';
        overlay.style.display = 'none';
        socket.emit('answer', { answer: currentAnswer });
});

// モーダルの「いいえ」ボタン処理
confirmNo.addEventListener('click', () => {
    modal.style.display = 'none';
    overlay.style.display = 'none';
});

// サーバーからの「insert_error」イベントを受け取る
socket.on('insert_error', (message) => {
    console.log("エラー:", message);
    alert(message); // 必要に応じてアラート表示
});

socket.on('end', () => {
    window.confirm("制限時間になりました");
    socket.emit('answer', { answer: "timeup" });
});

// サーバーからの「data_result」イベントを受け取る
socket.on('data_result', (message) => {
    alert(message); // 必要に応じてアラート表示
    window.location.href='kaitou3'
});

//ログアウト処理
async function logout() {
try {
    await new Promise((resolve, reject) => {
        socket.emit('session_destroy', (response) => {
            if (response.success) resolve();
            else reject(response.error);
        });
    });
    // 成功時はログインページにリダイレクト
    window.location.href = '/login';
} catch (error) {
    alert('ログアウトに失敗しました: ' + error);
}
}

socket.on('session_destroy_success', () => {
window.location.href = '/login';
});
        </script>
    </body>
</html>