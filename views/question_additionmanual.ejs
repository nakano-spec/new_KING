<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ã‚³ã‚­ã‚¿æ•™è‚²å§”å“¡ä¼šï¼šå•é¡Œè¿½åŠ </title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/stylesheets/question_additionmanual.css">
</head>
<body>
    <header class="header">
        <div class="menu-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div>ãƒ‹ã‚³ã‚­ã‚¿æ•™è‚²å§”å“¡ä¼šï¼šå•é¡Œè¿½åŠ </div>
        <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š<%= name %></div>
    </header>

    <nav class="sidebar" id="sidebar">
        <a href="/main">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</a>
        <a href="/mondai">å•é¡Œå‡ºé¡Œ</a>
        <a href="/Question_manage">å•é¡Œç®¡ç†</a>
        <a href="javascript:void(0);" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </nav>

    <!-- å³å´ã‹ã‚‰å‡ºã¦ãã‚‹å†™çœŸãƒ‘ãƒãƒ«ãƒœã‚¿ãƒ³ -->
    <div class="image-panel-button" id="imagePanelButton">å†™çœŸ</div>

    <!-- å³å´ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ãƒ‘ãƒãƒ« -->
    <div class="image-panel" id="imagePanel">
        <h2>ç”»åƒä¸€è¦§</h2>
        <div class="search-container">
                <input type="search" id="search-box" placeholder="å†™çœŸã‚’æ¤œç´¢">
                <span class="search-icon">ğŸ”</span>
                <button id="search-button">æ¤œç´¢</button>
        </div><br>
        <div class="image-list" id="imageListContainer"></div>
    </div>

    <div id = "zoomback">
        <img id = "zoomimg" src = "">
    </div>

    <main class="main-content">
        <h1 class="title">å…¥åŠ›å½¢å¼ã§ã®å•é¡Œè¿½åŠ </h1>
        <p class="subtitle">å„é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

        <form id="questionForm">
            <div class="form-group">
                <label class="form-label">å•é¡Œåï¼š</label>
                <input type="text" class="form-input" name="question_name" placeholder="ä¾‹: å•54" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">è©¦é¨“åï¼š</label>
                <input type="text" class="form-input" name="exam_name" placeholder="ä¾‹:å¿œç”¨æŠ€è¡“è€…è©¦é¨“" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">å¹´åº¦ï¼š</label>
                <input type="text" class="form-input" name="year" placeholder="ä¾‹: å¹³æˆ31å¹´åº¦æ˜¥" required>
            </div>

            <div class="form-group">
                <label class="form-label">ã‚¸ãƒ£ãƒ³ãƒ«ï¼š</label>
                <input type="text" class="form-input" name="genre" placeholder="ä¾‹: ãƒ†ã‚¯ãƒãƒ­ã‚¸ç³»" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">å•é¡Œæ–‡ï¼š</label>
                <textarea class="form-input question-text" name="question_text" required></textarea>
            </div>            

            <div id="choicesContainer" class="choices-container">
                <div class="form-group">
                    <label class="form-label">é¸æŠè‚¢1ï¼š</label>
                    <input type="text" class="form-input" name="choice1" placeholder="ä¾‹: ã‚¢:ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤">
                </div>
                <div class="form-group">
                    <label class="form-label">é¸æŠè‚¢2ï¼š</label>
                    <input type="text" class="form-input" name="choice2" placeholder="ä¾‹: ã‚¢:ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤">
                </div>
                <div class="form-group">
                    <label class="form-label">é¸æŠè‚¢3ï¼š</label>
                    <input type="text" class="form-input" name="choice3" placeholder="ä¾‹: ã‚¢:ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤">
                </div>
                <div class="form-group">
                    <label class="form-label">é¸æŠè‚¢4ï¼š</label>
                    <input type="text" class="form-input" name="choice4" placeholder="ä¾‹: ã‚¢:ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤">
                </div>
            </div>
            <p id="error-message" class="error-message"></p>
            <div class="form-group">
                <button type="button" class="add-choice-btn" id="addChoiceBtn">é¸æŠè‚¢è¿½åŠ </button>
                <button type="button" class="add-choice-btn" id="deleteChoiceBtn">é¸æŠè‚¢å‰Šé™¤</button>
            </div>

            <div class="form-group">
                <label class="form-label">å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«åï¼š</label>
                <input type="text" class="form-input" name="pics_name" value="<%= question.pics_name %>">
            </div>

            <div class="form-group">
                <label class="form-label">æ­£è§£ï¼š</label>
                <input type="text" class="form-input" name="correct" value="<%= question.answer %>" required>
            </div>

            <div class="upload-section">
                <label class="upload-label">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</label>
                <div class="dropzone" id="photo-dropzone">
                    ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">
                </div>
                <div class="file-list" id="photo-file-list">
                    <ul></ul>
                </div>
            </div>
            <div class="form-group">
                <button type="submit" class="submit-btn">å•é¡Œè¿½åŠ </button>
                <button class="submit-btn" onclick="window.history.back();">æˆ»ã‚‹</button>
            </div>
        </form>
    </main>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({transports: ['websocket'], upgrade: false});
        const optionsContainer = document.getElementById('options-container');
        const addOptionBtn = document.getElementById('add-option-btn');
        const errorMessage = document.getElementById('error-message');
        const zoom = document.querySelectorAll(".zoom");
        const zoomback = document.getElementById("zoomback");
        const zoomimg = document.getElementById("zoomimg");
        const photoInput = document.getElementById('photo-input');

        window.addEventListener('load', function(){			
           socket.emit('image_List');		
        });

       // ç”»åƒãƒªã‚¹ãƒˆå–å¾—å¾Œã€ãƒ‘ãƒãƒ«å†…ã«è¡¨ç¤º
       socket.on('imageList', function(files) {
            console.log('Received image list:', files);
            const imageListContainer = document.getElementById('imageListContainer');
            imageListContainer.innerHTML = ''; // åˆæœŸåŒ–

            files.forEach(file => {
                const imageItem = document.createElement('div');
                imageItem.classList.add('image-item');

                const img = document.createElement('img');
                img.src = '/images/' + file;
                img.classList.add('zoom')

                const fileName = document.createElement('p');
                fileName.textContent = file; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º

                imageItem.appendChild(img);
                imageItem.appendChild(fileName);
                imageListContainer.appendChild(imageItem);
            });

            const zoomElements = document.querySelectorAll('.zoom');
            zoomElements.forEach(function(value) {
                value.addEventListener("click", kakudai);
            });
        });

        socket.on('image_result', function(file) {
            console.log('Received image list:', file);
            const imageListContainer = document.getElementById('imageListContainer');
            imageListContainer.innerHTML = ''; // åˆæœŸåŒ–
            const imageItem = document.createElement('div');
            imageItem.classList.add('image-item');

            const img = document.createElement('img');
            img.src = '/images/' + file;
            img.classList.add('zoom')

            const fileName = document.createElement('p');
            fileName.textContent = file; // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º

            imageItem.appendChild(img);
            imageItem.appendChild(fileName);
            imageListContainer.appendChild(imageItem);

            const zoomElements = document.querySelectorAll('.zoom');
            zoomElements.forEach(function(value) {
                value.addEventListener("click", kakudai);
            });
        });

        socket.on('image_error', function(error) {
            console.log(error);
        });

        // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºéè¡¨ç¤º
        const imagePanelButton = document.getElementById('imagePanelButton');
        const imagePanel = document.getElementById('imagePanel');
        let panelOpen = false;

        imagePanelButton.addEventListener('click', function() {
            panelOpen = !panelOpen;
            if(panelOpen) {
                imagePanel.classList.add('open');
            } else {
                imagePanel.classList.remove('open');
            }
        });

        zoom.forEach(function(value) {
            value.addEventListener("click",kakudai);
        });

        function kakudai(e) {
            zoomback.style.display = "flex";
            zoomimg.setAttribute("src",e.target.getAttribute("src"));
        }

        zoomback.addEventListener("click",modosu);

        function modosu() {
            zoomback.style.display = "none";
        }

        // æ¤œç´¢ãƒœã‚¿ãƒ³
        document.getElementById('search-button').addEventListener('click', function() {
            var searchTerm = document.getElementById('search-box').value;
            if(searchTerm == ''){
                socket.emit('image_List')
            }else{
                socket.emit('search_img', searchTerm);
            }
        });

        document.getElementById('addChoiceBtn').addEventListener('click', function() {
            const container = document.getElementById('choicesContainer');
            const errorMessage = document.getElementById('error-message');
            if (container.children.length >= 10) {
                errorMessage.textContent = 'é¸æŠè‚¢ã¯æœ€å¤§10å€‹ã¾ã§è¿½åŠ ã§ãã¾ã™ã€‚';
                return;
            }
            const choiceCount = container.children.length + 1;
            
            const newChoice = document.createElement('div');
            newChoice.className = 'form-group';
            newChoice.innerHTML = `
                <label class="form-label">é¸æŠè‚¢${choiceCount}ï¼š</label>
                <input type="text" class="form-input" name="choice${choiceCount}" placeholder="ä¾‹: ã‚¢:ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤">
            `;
            
            container.appendChild(newChoice);
        });

        document.getElementById('deleteChoiceBtn').addEventListener('click', function() {
            const container = document.getElementById('choicesContainer');
            const errorMessage = document.getElementById('error-message');
            if (container.children.length < 1) {
                errorMessage.textContent = 'é¸æŠè‚¢ã¯ãã‚Œä»¥ä¸Šæ¶ˆã›ã¾ã›ã‚“ã€‚';
                return;
            }
            container.removeChild(container.lastElementChild);
        });

        function setupPhotoUpload() {
            const dropzone = document.getElementById('photo-dropzone');
            const input = document.getElementById('photo-input');
            const fileList = document.getElementById('photo-file-list').querySelector('ul');

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                displayFiles(files);
            });

            dropzone.addEventListener('click', () => {
                input.click();
            });

            input.addEventListener('change', () => {
                const files = input.files;
                displayFiles(files);
            });

            function displayFiles(files) {
                fileList.innerHTML = '';
                for (let i = 0; i < files.length; i++) {
                    const li = document.createElement('li');
                    li.textContent = files[i].name;
                    fileList.appendChild(li);
                }
            }
        }

        setupPhotoUpload();

        document.getElementById('questionForm').addEventListener('submit', function(event) {
            event.preventDefault(); 

            const form = document.getElementById('questionForm');
            const requiredElements = form.querySelectorAll('[required]');
            const choicesContainer = document.getElementById('choicesContainer');
            const choiceInputs = choicesContainer.querySelectorAll('input[name^="choice"]');

            let hasError = false;
            let errorMessage = '';

            requiredElements.forEach(elem => {
                if (!elem.value.trim()) {
                    hasError = true;
                    errorMessage = 'æœªå…¥åŠ›é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                }
            });

            // é¸æŠè‚¢ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆã€Œ:ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã ã‘ã‚’ç¢ºèªï¼‰
            if (!hasError) {
                choiceInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value !== '' && !/.+[:ï¼š].+/.test(value)) { // ç©ºã§ãªã‘ã‚Œã°å½¢å¼ãƒã‚§ãƒƒã‚¯
                        hasError = true;
                        errorMessage = 'é¸æŠè‚¢ã¯ã€Œå†…å®¹:å†…å®¹ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    }
                });
            }

            // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (hasError) {
                window.alert(`å…¥åŠ›ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
                return;
            }

            const file2 = photoInput.files[0];

            if (!file2) {
            }else{
                console.log(file2);
            }


            // å…¨ã¦å…¥åŠ›æ¸ˆã¿ã®å ´åˆã€å…¥åŠ›å†…å®¹ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
            const formData = new FormData(form);
            let resultText = "ä»¥ä¸‹ã®å†…å®¹ã§å•é¡Œã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\n\n";

            // ãƒ†ã‚­ã‚¹ãƒˆé …ç›®ã®è¡¨ç¤º
            for (let [key, value] of formData.entries()) {
                resultText += `${key}: ${value}\n`;
            }

            // å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
            const fileListUl = document.querySelector('#photo-file-list ul');
            if (fileListUl && fileListUl.children.length > 0) {
                resultText += "\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸãƒ•ã‚¡ã‚¤ãƒ«:\n";
                for (let li of fileListUl.children) {
                    resultText += `- ${li.textContent}\n`;
                }
            }

            // å…¨éƒ¨è¡¨ç¤ºã—ã¦ç¢ºèª
            const confirmResult = window.confirm(resultText);

            if(confirmResult) {
                // ã“ã“ã§ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹å‡¦ç†ãªã©ã‚’è¡Œã†
                const formObject = Object.fromEntries(formData.entries());
                socket.emit('question_add', formObject);
                alert('å•é¡Œã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
                console.log("ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹:", formObject);
            } else {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆä½•ã‚‚ã—ãªã„
            }
        });

        socket.on('complete',async function(complete){
            const file = photoInput.files[0];

            if (file) {
                const formData2 = new FormData();
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
                const newFile = new File([file], sanitizedFileName, { type: file.type });
                formData2.append('images', newFile);
                for (let [key, value] of formData2.entries()) {
                    console.log(`${key}:`, value);
                }
                try {
                    $.ajax({
                        url: '/upload', // ç›¸å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨
                        method: 'POST',
                        data: formData2,
                        processData: false,
                        contentType: false
                    }).done(function(res){
                        console.log(res);
                        alert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ!`);
                        window.location.href = '/Question_manage';
                    }).fail(function(err){
                        console.log(err);
                        alert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${err.responseJSON.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'}`);
                    });
                } catch (error) {
                    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                }
            } else {
                //alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                window.location.href = '/Question_manage';
            }
        })

        const menuButton = document.querySelector('.menu-icon'); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’å–å¾—
            const sidebar = document.getElementById('sidebar'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å–å¾—
            const mainContent = document.querySelector('.main-content'); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            menuButton.addEventListener('click', () => {
                sidebar.classList.toggle('active'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                mainContent.classList.toggle('sidebar-active'); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½™ç™½èª¿æ•´
            });

            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
            document.addEventListener('click', (event) => {
                if (!menuButton.contains(event.target) && !sidebar.contains(event.target)) {
                    sidebar.classList.remove('active'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    mainContent.classList.remove('sidebar-active'); // ä½™ç™½èª¿æ•´ã‚’è§£é™¤
                }
            });

            //ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            async function logout() {
                try {
                    await new Promise((resolve, reject) => {
                        socket.emit('session_destroy', (response) => {
                            if (response.success) resolve();
                            else reject(response.error);
                        });
                    });
                    // æˆåŠŸæ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = '/login';
                } catch (error) {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
            
            socket.on('session_destroy_success', () => {
                window.location.href = '/login';
            });
    </script>
</body>
</html>